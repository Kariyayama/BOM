---
title: "Untitled"
output: html_document
date: "2022-11-08"
---

```{r}
curdir <- "~/Labolatory/JST_Mouse_Human/Tabula/Integration"
# renv::restore()

setwd(curdir)
library(here)
set_here(curdir)
```

```{r}
library(tidyverse)
library(Seurat)
library(SingleCellExperiment)
library(gridExtra)
library(cowplot)
```

ヒト肝臓データの読み込み
```{r}
readRDS(file="/Users/kariyayama/Labolatory/JST_Mouse_Human/Tabula/Tabula_sapiens/TS_liver.rds") -> Hs_liver
Hs_cell <- c()

## 細胞リストの作成
# celltype pick
for(cell_type in unique(Hs_liver@meta.data$cell_ontology_class)){
  Hs_liver@meta.data %>% 
    dplyr::filter(cell_ontology_class == cell_type) %>%
    nrow -> n.cell_type
  
  if(n.cell_type > 200){
    Hs_liver@meta.data %>%
      dplyr::filter(cell_ontology_class == cell_type) %>%
      slice_sample(n=200) %>%
      rownames %>%
      c(Hs_cell, .) -> Hs_cell
  }else{
    Hs_liver@meta.data %>%
      dplyr::filter(cell_ontology_class == cell_type) %>%
      rownames %>%
      c(Hs_cell, .) -> Hs_cell
  }
}

# version 2, 全ての細胞からランダムに500細胞
# Hs_liver@meta.data %>%
#       slice_sample(n=500) %>%
#       rownames -> Hs_cell
```

統合に用いる細胞の選択
```{r}
Hs_liver@assays$RNA@counts %>%
  as.data.frame() %>%
  dplyr::select(all_of(Hs_cell)) %>%
  rownames_to_column(var= "Gene_name") %>%
  inner_join(Hs_Mm, by ="Gene_name") %>%
  dplyr::select(c(-Mouse_gene_name)) -> Hs_liver.one2one.table
```

マウス肝臓のデータの読み込み
```{r}
readRDS(file="/Users/kariyayama/Labolatory/JST_Mouse_Human/Tabula/Tabula_muris/tabula-muris/Liver.RDS") -> Mm_liver

# Liverのmeta dataに細胞種の情報が入っていなかった
readRDS(file="/Users/kariyayama/Labolatory/JST_Mouse_Human/Tabula/Tabula_muris/tabula-muris/00_data_ingest/Tabula_muris.all_cell.rds")@meta.data -> Mm_all_cells
Mm_all_cells %>% filter(tissue == "Liver") -> Mm_metadata
Mm_cell <- c()

## 細胞リストの作成
# celltype pick
for(cell_type in unique(Mm_metadata$cell_ontology_class)){
  Mm_metadata %>% 
    dplyr::filter(cell_ontology_class == cell_type) %>%
    nrow -> n.cell_type
  
  if(n.cell_type > 200){
    Mm_metadata %>%
      dplyr::filter(cell_ontology_class == cell_type) %>%
      slice_sample(n=200) %>%
      rownames %>%
      c(Mm_cell, .) -> Mm_cell
  }else{
    Mm_metadata %>%
      dplyr::filter(cell_ontology_class == cell_type) %>%
      rownames %>%
      c(Mm_cell, .) -> Mm_cell
  }
}

# Version 2, ランダムに500細胞
# Mm_metadata %>%
#       slice_sample(n=500) %>%
#       rownames -> Mm_cell
```

統合に用いる細胞の選択
```{r}
Mm_liver@assays$RNA@counts %>%
  as.data.frame() %>%
  dplyr::select(all_of(Mm_cell)) %>%
  rownames_to_column(var= "Mouse_gene_name") %>%
  inner_join(Hs_Mm, by ="Mouse_gene_name") %>%
  dplyr::select(c(-Mouse_gene_name)) -> Mm_liver.one2one.table
```

解析に使う遺伝子の選択
```{r}
Hs_liver.one2one.table %>% 
  inner_join(Mm_liver.one2one.table, by = "Gene_name") %>%
  dplyr::select("Gene_name") -> gene_list
```

Seuratオブジェクトの作成
```{r}
sp.ident <- rep("Hs", nrow(Hs_liver@meta.data[Hs_cell,]))
Hs_liver.one2one.table %>%
  inner_join(gene_list, by = "Gene_name") %>%
  column_to_rownames(var = "Gene_name") %>%
  dplyr::select(all_of(Hs_cell)) %>%
  as.matrix %>%
  CreateSeuratObject() -> Hs_liver.one2one
Hs_liver.one2one@meta.data <- cbind(Hs_liver@meta.data[Hs_cell,], sp.ident)

Hs_liver.one2one <- NormalizeData(Hs_liver.one2one)
Hs_liver.one2one <- ScaleData(Hs_liver.one2one, do.scale=T, do.center=T, display.progress = T)
Hs_liver.one2one <- FindVariableFeatures(Hs_liver.one2one, do.plot = F, nFeature=2000)

sp.ident <- rep("Mm", nrow(Mm_liver@meta.data[Mm_cell,]))
Mm_liver.one2one.table %>%
  inner_join(gene_list, by = "Gene_name") %>%
  column_to_rownames(var = "Gene_name") %>%
  dplyr::select(all_of(Mm_cell)) %>%
  as.matrix %>%
  CreateSeuratObject() -> Mm_liver.one2one
Mm_liver.one2one@meta.data <- cbind(Mm_metadata[Mm_cell,], sp.ident)

Mm_liver.one2one <- NormalizeData(Mm_liver.one2one)
Mm_liver.one2one <- ScaleData(Mm_liver.one2one, do.scale=T, do.center=T, display.progress = T)
Mm_liver.one2one <- FindVariableFeatures(Mm_liver.one2one, do.plot = F, nFeature=2000)
```

```{r}
genes.use = Reduce(intersect, list(VariableFeatures(Hs_liver.one2one),
                                   VariableFeatures(Mm_liver.one2one),
                                   rownames(Hs_liver.one2one),
                                   rownames(Mm_liver.one2one)))
```

# Integraionなし
```{r}
# Plot data before integration
## Combine our Seurat objects
Liver.combined <- merge(Hs_liver.one2one, Mm_liver.one2one,
                        add.cell.ids = c("Hs", "Mm"),
                        project = "Liver")

# cbind(Mm_liver.one2one@assays$RNA@counts,
#       Hs_liver.one2one@assays$RNA@counts) %>%
#   CreateSeuratObject() -> Liver.combined
Liver.combined <- ScaleData(Liver.combined, do.scale=T, do.center=T, display.progress = T)
VariableFeatures(Liver.combined) = genes.use

## Run PCA and UMAP
Liver.combined = RunPCA(Liver.combined, do.print=FALSE)
ElbowPlot(object = Liver.combined)


Liver.combined <- RunUMAP(Liver.combined, dims = 1:16)
DimPlot(Liver.combined, group.by = "sp.ident")
DimPlot(Liver.combined, split.by = "sp.ident", group.by = "cell_ontology_class", repel = T, label = T)  + NoLegend() -> p1
DimPlot(Liver.combined, group.by = "sp.ident") -> p2
DimPlot(Liver.combined, group.by = "cell_ontology_class", repel = T, label = T) + NoLegend() -> p3
p1 + {p2 + p3} -> p4
ggsave("Liver/Hs_Mm_liver.no_integration.celltype_pick.version0.png", p4, width = 12, height = 12)
```
統合はうまくいっていない

```{r}
Hs_Mm.list <- list(Hs = Hs_liver.one2one, Mm = Mm_liver.one2one)
features <- SelectIntegrationFeatures(object.list = Hs_Mm.list)
Hs_Mm.anchors <- FindIntegrationAnchors(object.list = Hs_Mm.list, anchor.features = features)
# this command creates an 'integrated' data assay
Hs_Mm.seurat.combined <- IntegrateData(anchorset = Hs_Mm.anchors)

DefaultAssay(Hs_Mm.seurat.combined) <- "integrated"
Hs_Mm.seurat.combined <- ScaleData(Hs_Mm.seurat.combined)
## Run PCA and UMAP
Hs_Mm.seurat.combined <- RunPCA(Hs_Mm.seurat.combined, do.print=FALSE, )
ElbowPlot(object = Hs_Mm.seurat.combined, ndims = 50)
```
UMAP＋可視化
```{r}
Hs_Mm.seurat.combined <- RunUMAP(Hs_Mm.seurat.combined, dims = 1:23)
DimPlot(Hs_Mm.seurat.combined, split.by = "sp.ident", group.by = "cell_ontology_class", repel = T, label = T)  + NoLegend() -> p1
DimPlot(Hs_Mm.seurat.combined, group.by = "sp.ident") -> p2
DimPlot(Hs_Mm.seurat.combined, group.by = "cell_ontology_class", repel = T, label = T) + NoLegend() -> p3
p1 + {p2 + p3} -> p4
ggsave("Liver/Hs_Mm_liver.seurat_integrate.celltype_pick.version0.png", p4, width = 12, height = 12)
p4
```
統合はある程度うまく行っている。具体的にはNK細胞とT細胞やプラズマ細胞とB細胞、クッパー細胞とマクロファージ、はある程度統合がうまく行っている。一方で、HepatocyteとEndothelial cell of hepatic sinusoid (LSECs)はあまりうまく行っていない。Hepatocyteは種特異的な遺伝子の発現の高さと関係があるかもしれない。
一方で、LSECsは種特異的な遺伝子の発現量が多い細胞集団ではないため、種特異的な遺伝子の発現量の高さと種特異的な細胞集団は必ずしも相関しないようだ。

LSECsについて：https://www.sciencedirect.com/science/article/pii/S0168827816303336?via%3Dihub#f0015
```{r}
Hs_Mm.seurat.combined <- FindNeighbors(Hs_Mm.seurat.combined,
                                       reduction = "pca", dims = 1:23)
Hs_Mm.seurat.combined <- FindClusters(Hs_Mm.seurat.combined,
                                      resolution = 0.5)

DimPlot(Hs_Mm.seurat.combined, split.by = "sp.ident", group.by = "ident", repel = T, label = T)  + NoLegend() -> p1.ident
p1.ident %>%
  ggsave("Liver/Hs_Mm_liver.seurat_integrate.celltype_pick.ident.version0.png",
         ., width = 12, height = 8)

```
細胞数をカウントする
```{r}
Hs_Mm.seurat.combined@meta.data %>%
  select(c("sp.ident", "seurat_clusters")) %>%
  dplyr::group_by(sp.ident) %>%
  dplyr::count(seurat_clusters) %>%
  pivot_wider(id_cols = "seurat_clusters",
              names_from = "sp.ident",
              values_from = "n")
```

マーカー遺伝子の抽出
```{r}
# マウス
Mm_liver@assays$RNA@counts[,Mm_cell] %>%
  CreateSeuratObject() -> Mm_liver.picked
Mm_liver.picked[["integrated_seurat_cluster"]] <- liver.only.sum.meta %>% 
  filter(sp.ident == "Mm") %>%
  select(seurat_clusters)
  
SCTransform(Mm_liver.picked, variable.features.n = 2000)

# Ident情報を細胞型情報に変換
liver.only.sum.meta %>% 
  filter(sp.ident == "Mm") %>%
  select(seurat_clusters) %>%
  t -> Mm_cell.ident
Mm_cell.ident %>%
  as.character() -> cell_idents
liver.only.sum.meta %>% 
  filter(sp.ident == "Mm") %>%
  select(Cell) %>% 
  unlist %>%
  as.vector -> cell.list
names(cell_idents) <- cell.list
cell_idents %>%
  unique %>%
  as.numeric %>%
  sort %>%
  as.character -> cell_levels

Mm_cell.ident <- factor(cell_idents, levels = cell_levels)
Mm_liver.picked@active.ident <- Mm_cell.ident
Mm_liver.picked.markers <- FindAllMarkers(Mm_liver.picked,
                                          only.pos = TRUE,
                                          min.pct = 0.25,
                                          logfc.threshold = 0.25
                                          )
Mm_liver.picked.markers %>%
  filter(p_val_adj < 0.05) %>%
  write.table(file = "Liver/Hs_Mm_liver.seurat_integrate.celltype_pick.Mm_markergene.version0.tsv",
              sep = "\t",
              row.names = F,
              quote = F)

# ヒト
Hs_liver@assays$RNA@counts[,Hs_cell] %>%
  CreateSeuratObject() -> Hs_liver.picked
Hs_liver.picked[["integrated_seurat_cluster"]] <- liver.only.sum.meta %>% 
  filter(sp.ident == "Hs") %>%
  select(seurat_clusters)
  
SCTransform(Hs_liver.picked, variable.features.n = 2000)

# Ident情報を細胞型情報に変換
liver.only.sum.meta %>% 
  filter(sp.ident == "Hs") %>%
  select(seurat_clusters) %>%
  t -> Hs_cell.ident
Hs_cell.ident %>%
  as.character() -> cell_idents
liver.only.sum.meta %>% 
  filter(sp.ident == "Hs") %>%
  select(Cell) %>% 
  unlist %>%
  as.vector -> cell.list
names(cell_idents) <- cell.list
cell_idents %>%
  unique %>%
  as.numeric %>%
  sort %>%
  as.character -> cell_levels

Hs_cell.ident <- factor(cell_idents, levels = cell_levels)
Hs_liver.picked@active.ident <- Hs_cell.ident
# マーカー遺伝子抽出
Hs_liver.picked.markers <- FindAllMarkers(Hs_liver.picked,
                                          only.pos = TRUE,
                                          min.pct = 0.25,
                                          logfc.threshold = 0.25
                                          )

# 全体を保存
Hs_liver.picked.markers %>%
  filter(p_val_adj < 0.05) %>%
  write.table(file = "Liver/Hs_Mm_liver.seurat_integrate.celltype_pick.Hs_markergene.version0.tsv",
              sep = "\t",
              row.names = F,
              quote = F)

```

オブジェクトを保存する
```{r}
saveRDS(Mm_liver.picked, file = "Liver/Mm_liver.picked.version0.rds")
saveRDS(Hs_liver.picked, file = "Liver/Hs_liver.picked.version0.rds")
saveRDS(Hs_Mm.seurat.combined, file = "Liver/Hs_Mm.seurat.combined.version0.rds")
```


ここから旧種特異的遺伝子リスト
種特異的な遺伝子の発現量をプロット
```{r}
Hs_Mm.seurat.combined@meta.data %>%
  rownames_to_column(var = "Cell") ->
  Hs_Mm.seurat.meta.data

# 系統特異的な遺伝子リストを用意
Hs_only <- read_tsv("Gene_list/211210_only_human_gene.symbol.txt",
                    show_col_types = FALSE)
Mm_only <- read_tsv("Gene_list/211210_only_mouse_gene.symbol.txt",
                    show_col_types = FALSE)

# 系統特異的な遺伝子の合計を細胞ごとに計算
Mm_liver@assays$RNA@data %>%
  as.data.frame %>%
  rownames_to_column("Gene") %>%
  inner_join(Mm_only, by = c("Gene" = "Gene_name")) %>%
  column_to_rownames(var = "Gene") %>%
  apply(2, sum) -> Mm_liver.Mm_only.sum

Hs_liver@assays$RNA@data %>%
  as.data.frame %>%
  rownames_to_column("Gene") %>%
  inner_join(Hs_only, by = c("Gene" = "Gene_name")) %>%
  column_to_rownames(var = "Gene") %>%
  apply(2, sum) -> Hs_liver.Hs_only.sum

liver_only <- c(Mm_liver.Mm_only.sum, Hs_liver.Hs_only.sum)
data.frame(Cell = names(liver_only),
           SUM = liver_only) %>%
  as_tibble %>%
  inner_join(Hs_Mm.seurat.meta.data, by = "Cell") -> liver.only.sum.meta

# 系統特異的な遺伝子の合計をプロット
liver.only.sum.meta %>%
    ggplot(aes(x = seurat_clusters, y = SUM, fill = seurat_clusters)) +
    geom_violin() +
    facet_wrap( ~ sp.ident) +
    geom_dotplot(binaxis = "y", stackdir = "center", binwidth = 5) +
    theme_classic() +
    NoLegend() -> p5.sum
p1 + p1.ident + p5.sum -> p6

```

ヒトとマウスについて、マーカー遺伝子のうち種特異的なものを抽出
```{r}
# マウス特異的遺伝子
Mm_liver.picked.markers %>%
  inner_join(Mm_only, by = c("gene" = "Gene_name")) %>%
  filter(p_val_adj < 0.05) %>%
  write.table(file = "Liver/Hs_Mm_liver.seurat_integrate.celltype_pick.Mm_only.markergene.version0.tsv",
              sep = "\t",
              row.names = F,
              quote = F)
```

マウスの場合、種特異的な遺伝子の発現量が大きいHepatocyte(Ident: 3)でマーカー遺伝子と判断される種特異的な遺伝子の数が多い
```{r}
# ヒト特異的マーカー遺伝子
Hs_liver.picked.markers %>%
  inner_join(Hs_only, by = c("gene" = "Gene_name")) %>%
  filter(p_val_adj < 0.05) %>%
  write.table(file = "Liver/Hs_Mm_liver.seurat_integrate.celltype_pick.Mm_only.markergene.version0.tsv",
              sep = "\t",
              row.names = F,
              quote = F)
```

マーカー遺伝子のうち、種特異的な遺伝子が占める割合をプロットする
```{r}
# マウス
Mm_liver.picked.markers %>%
  inner_join(Mm_only, by = c("gene" = "Gene_name")) %>%
  filter(p_val_adj < 0.05) %>%
  dplyr::count(cluster) -> Mm_liver.picked.only_markers.counts
Mm_liver.picked.markers %>%
  filter(p_val_adj < 0.05) %>%
  dplyr::count(cluster) %>%
  inner_join(Mm_liver.picked.only_markers.counts,
             by = "cluster") %>%
  mutate(sp = "Mm") %>%
  mutate(ratio = n.y / n.x) -> Mm_liver.picked.counts

# ヒト
Hs_liver.picked.markers %>%
  inner_join(Hs_only, by = c("gene" = "Gene_name")) %>%
  filter(p_val_adj < 0.05) %>%
  dplyr::count(cluster) -> Hs_liver.picked.only_markers.counts
Hs_liver.picked.markers %>%
  filter(p_val_adj < 0.05) %>%
  dplyr::count(cluster) %>%
  inner_join(Hs_liver.picked.only_markers.counts,
             by = "cluster")  %>%
  mutate(sp = "Hs") %>%
  mutate(ratio = n.y / n.x) -> Hs_liver.picked.counts

# ヒトとマウスの統合
Hs_liver.picked.counts %>%
  bind_rows(Mm_liver.picked.counts) %>%
  ggplot(aes(x=cluster, y = n.y, fill = cluster)) +
    geom_bar(stat = "identity") +
    facet_wrap( ~ sp) +
    theme_classic() +
    NoLegend() -> p7
p6 + p7 -> p8
p8 %>%
  ggsave("Liver/Hs_Mm_liver.seurat_integrate.celltype_pick.only_gene.version0.png", 
         ., width = 12, height = 20)

```

Ratioで計算する
```{r}
# 系統特異的な遺伝子の合計を細胞ごとに計算
Mm_liver@assays$RNA@data %>%
  as.data.frame %>%
  apply(2, sum) -> Mm_liver.all.sum

Hs_liver@assays$RNA@data %>%
  as.data.frame %>%
  apply(2, sum) -> Hs_liver.all.sum

liver_all <- c(Mm_liver.all.sum, Hs_liver.all.sum)
data.frame(Cell = names(liver_all),
           SUM.all = liver_all) %>%
  as_tibble %>%
  inner_join(liver.only.sum.meta, by = "Cell") -> liver.sum.meta

# 系統特異的な遺伝子の合計をプロット
liver.sum.meta %>%
    mutate(ratio = SUM / SUM.all) %>%
    ggplot(aes(x = seurat_clusters, y = ratio, fill = seurat_clusters)) +
    geom_violin() +
    facet_wrap( ~ sp.ident) +
    geom_dotplot(binaxis = "y", stackdir = "center", binwidth = 0.0005) +
    theme_classic() +
    NoLegend() -> p5.ratio

# ヒトとマウスの割合をプロット
Hs_liver.picked.counts %>%
  bind_rows(Mm_liver.picked.counts) %>%
  ggplot(aes(x=cluster, y = ratio, fill = cluster)) +
    geom_bar(stat = "identity") +
    facet_wrap( ~ sp) +
    theme_classic() +
    NoLegend() -> p7.ratio
p1 + p1.ident + p5.ratio + p7.ratio-> p8.ratio
p8.ratio %>%
  ggsave("Liver/Hs_Mm_liver.seurat_integrate.celltype_pick.only_gene.ratio.version0.png", 
         ., width = 12, height = 20)
```

