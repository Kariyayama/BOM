---
title: "Lung"
output: html_document
date: "2022-12-22"
---
細胞クラスターで特異的に発現しているヒト特異的遺伝子とマウス特異的遺伝子のGO解析
```{r}
library(rbioapi)
library(tidyverse)
library(SingleCellExperiment)
library(gridExtra)
library(cowplot)
setwd("/Users/kariyayama/Labolatory/JST_Mouse_Human/Tabula/Integration")
source("run_seurat_GO_analysis.R")
```

BP: GO:0008150
MF: GO:0003674
CC: GO:0005575
```{r}
input <- "Lung"
outdir <- paste(curdir, input, sep = "/")
```

定数定義
```{r}
test_type <- "FISHER"
cutoff <- 0.05
hsapiens <- 9606
mmuculus <- 10090
# BP <- "GO:0008150"
BP <- "ANNOT_TYPE_ID_PANTHER_GO_SLIM_BP"
```

全てのIdentに対して実行
```{r}
# 細胞クラスターの一覧を取得する                                             
read_marker_gene_list("Hs", "_") -> Hs_all
read_marker_gene_list("Mm", "_") -> Mm_all
bind_rows(Hs_all, Mm_all) %>%
  select(cluster) %>% unlist %>%
  as.numeric %>% unique %>%
  sort %>% as.character -> cluster.list
```

GO解析
```{r}
run_GOanalysis_for_all_ident("Hs", hsapiens, cluster.list)
run_GOanalysis_for_all_ident("Mm", mmuculus, cluster.list)
```
GO解析の結果をプロットして可視化
GO解析の結果を読み込み
```{r}
# 定数
threshold <- -log10(0.05)
plot_para <- element_text(angle = 90, vjust = 0.5, hjust = 0)
height = 16
width <- function(x)  x * 0.05 + 5
```  

全ヒト ・マウス：マウス共通の細胞クラスターについて、種特異的なマーカー遺伝子vsそれ以外のGO解析の結果を可視化する
```{r}
for(ident in cluster.list){
  print(ident)
  # GO解析の結果を読み込み
  classify_GO_term(ident, sp = "Hs") -> hs.ident
  classify_GO_term(ident, sp = "Mm") -> mm.ident
  
  # Plot
  hs.ident %>%
    create_plot -> Hs.p
  mm.ident %>%
    create_plot -> Mm.p
  Hs.p | Mm.p -> outplot
  
  # 保存
  outfile <- paste(outdir, "/PANTHER/Comparison/All/compare_ident_",
                   ident, "_human-mouse.png", sep= "")
  height <- decide_height(hs.ident, mm.ident)
  ggsave(outfile, outplot, width = 12, height = height)
}
```


